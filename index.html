<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Letter Race Debug</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#061018;font-family:system-ui}
  canvas{display:block;width:100vw;height:100vh}

  #hud{
    position:fixed;left:10px;top:10px;right:10px;display:flex;justify-content:space-between;gap:10px;pointer-events:none
  }
  .pill{
    pointer-events:auto;
    background:rgba(255,255,255,0.14);
    border:1px solid rgba(255,255,255,0.16);
    color:#fff;padding:8px 12px;border-radius:12px;font-weight:800
  }
  #help{
    position:fixed;left:12px;right:12px;bottom:12px;display:flex;justify-content:space-between;gap:10px;pointer-events:none
  }
  .btn{
    pointer-events:auto;
    background:rgba(255,255,255,0.14);
    border:1px solid rgba(255,255,255,0.16);
    color:#fff;padding:12px 16px;border-radius:14px;font-weight:900;min-width:120px;text-align:center;user-select:none
  }
  #err{
    position:fixed;left:10px;right:10px;top:64px;
    background:rgba(255,60,60,0.14);
    border:1px solid rgba(255,60,60,0.22);
    color:#fff;padding:10px 12px;border-radius:12px;
    font-weight:700;white-space:pre-wrap;display:none
  }
</style>
</head>
<body>

<canvas id="c"></canvas>

<div id="hud">
  <div class="pill">Doelletter: <span id="letter">b</span></div>
  <div class="pill" id="score">Score: 0</div>
  <div class="pill" id="dbg">debug: start</div>
</div>

<div id="err"></div>

<div id="help">
  <div class="btn" id="leftBtn">Links</div>
  <div class="btn" id="rightBtn">Rechts</div>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha: false });

  const elLetter = document.getElementById("letter");
  const elScore = document.getElementById("score");
  const elDbg = document.getElementById("dbg");
  const elErr = document.getElementById("err");

  function showErr(msg){
    elErr.style.display = "block";
    elErr.textContent = String(msg);
  }

  window.addEventListener("error", (e) => {
    showErr("JavaScript fout:\n" + (e?.message || e));
  });

  function resize(){
    const w = window.innerWidth;
    const h = window.innerHeight;
    canvas.width = w;
    canvas.height = h;
  }
  window.addEventListener("resize", resize);
  resize();

  // Hard bewijs dat canvas zichtbaar is en script draait
  function drawSanity(){
    const w = canvas.width, h = canvas.height;
    ctx.fillStyle = "#061018";
    ctx.fillRect(0,0,w,h);

    ctx.fillStyle = "rgba(255,255,255,0.18)";
    ctx.fillRect(0, Math.floor(h*0.62), w, 10);

    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(0, Math.floor(h*0.62)+10, w, 3);

    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.font = "800 16px system-ui";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillText("Canvas OK", 12, 12);
  }
  drawSanity();

  // Assets
  const carStraight = new Image();
  const carLeft = new Image();
  const carRight = new Image();

  let carsReady = 0;
  const onCarLoad = () => { carsReady += 1; };
  const onCarFail = (name) => showErr("Afbeelding niet geladen:\n" + name + "\nControleer bestandsnaam en map, GitHub Pages is hoofdletter gevoelig.");

  carStraight.onload = onCarLoad;
  carLeft.onload = onCarLoad;
  carRight.onload = onCarLoad;

  carStraight.onerror = () => onCarFail("car_straight.png");
  carLeft.onerror = () => onCarFail("car_left.png");
  carRight.onerror = () => onCarFail("car_right.png");

  carStraight.src = "./car_straight.png";
  carLeft.src = "./car_left.png";
  carRight.src = "./car_right.png";

  // Letters
  const letters = ["b","g","v","m","z","h","k","l","s","w"];
  let target = "b";
  let score = 0;

  function newTarget(){
    target = letters[Math.floor(Math.random() * letters.length)];
    elLetter.textContent = target;
  }
  function updateScore(){
    elScore.textContent = "Score: " + score;
  }
  newTarget();
  updateScore();

  // Pseudo 3D road
  const segmentLength = 42;
  const drawDistance = 220;
  const roadWidth = 1200;

  let segments = [];
  function addStraight(n){ for(let i=0;i<n;i++) segments.push({ curve: 0 }); }
  function addCurve(n, c){ for(let i=0;i<n;i++) segments.push({ curve: c }); }

  function buildTrack(){
    segments = [];
    addStraight(120);
    for(let i=0;i<18;i++){
      addStraight(90 + Math.floor(Math.random() * 60));
      const dir = Math.random() < 0.5 ? -1 : 1;
      addCurve(34 + Math.floor(Math.random() * 24), dir * (0.22 + Math.random() * 0.38));
    }
    addStraight(260);
  }
  buildTrack();

  // Player
  let lane = 1;
  let steer = "straight";
  let steerHold = 0;

  let position = 0;
  let speed = 160;

  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

  function segIndexAt(z){
    const i = Math.floor(z / segmentLength);
    return ((i % segments.length) + segments.length) % segments.length;
  }

  function quad(x1,y1,w1, x2,y2,w2, color){
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(x1 - w1, y1);
    ctx.lineTo(x2 - w2, y2);
    ctx.lineTo(x2 + w2, y2);
    ctx.lineTo(x1 + w1, y1);
    ctx.closePath();
    ctx.fill();
  }

  function render(){
    const w = canvas.width, h = canvas.height;

    // achtergrond, extra duidelijk
    ctx.fillStyle = "#061018";
    ctx.fillRect(0,0,w,h);

    // basis horizonlijn
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.fillRect(0, Math.floor(h*0.35), w, 2);

    const base = segIndexAt(position);

    let x = 0;
    let dx = 0;
    let maxY = h;

    // projectie constants, bewust simpel en stabiel
    const proj = 280;         // bepaalt perspectief sterkte
    const roadScale = 1.15;   // globale breedte afstelling
    const yBase = h * 0.84;   // waar de weg de onderkant raakt

    for(let n = drawDistance; n > 0; n--){
      const idx = (base + n) % segments.length;
      const seg = segments[idx];

      dx += seg.curve;
      x += dx;

      const z1 = n * segmentLength;
      const z2 = (n + 1) * segmentLength;

      const s1 = proj / z1;
      const s2 = proj / z2;

      const y1 = yBase - s1 * 520;
      const y2 = yBase - s2 * 520;

      if(y2 >= maxY) continue;
      maxY = y2;

      const rw1 = (s1 * roadWidth) / roadScale;
      const rw2 = (s2 * roadWidth) / roadScale;

      const x1 = (w/2) + x * s1 * 60;
      const x2 = (w/2) + (x + dx) * s2 * 60;

      // heel contrastrijk voor debug
      const stripe = (idx % 2) === 0;
      const rumble = stripe ? "rgba(255,255,255,0.10)" : "rgba(255,255,255,0.06)";
      const asphalt = stripe ? "rgba(40,55,72,0.96)" : "rgba(32,45,60,0.96)";

      quad(x1,y1, rw1 + 32*s1, x2,y2, rw2 + 32*s2, rumble);
      quad(x1,y1, rw1,          x2,y2, rw2,          asphalt);

      // middenstreep
      if((idx % 3) === 0){
        quad(x1,y1, 4*s1, x2,y2, 4*s2, "rgba(255,255,255,0.70)");
      }
    }

    // Auto, altijd zichtbaar zelfs als images niet laden
    const carW = Math.min(170, w * 0.26);
    const carX = (w/2) + (lane - 1) * (w * 0.18);
    const carY = h - carW * 0.78;

    ctx.fillStyle = "rgba(0,0,0,0.28)";
    ctx.beginPath();
    ctx.ellipse(carX, carY + carW*0.30, carW*0.26, carW*0.11, 0, 0, Math.PI*2);
    ctx.fill();

    let img = carStraight;
    if(steer === "left") img = carLeft;
    if(steer === "right") img = carRight;

    if(img && img.complete && img.naturalWidth > 0){
      ctx.drawImage(img, carX - carW/2, carY - carW/2, carW, carW);
    } else {
      // fallback blok, zodat je altijd iets ziet
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.fillRect(carX - carW*0.22, carY - carW*0.22, carW*0.44, carW*0.44);
      ctx.fillStyle = "rgba(0,0,0,0.55)";
      ctx.font = "900 16px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("car", carX, carY);
    }
  }

  function update(dt){
    position += speed * dt;
    const trackLen = segments.length * segmentLength;
    if(position >= trackLen) position -= trackLen;

    if(steerHold > 0){
      steerHold -= 1;
      if(steerHold === 0) steer = "straight";
    }
  }

  function move(dir){
    const prev = lane;
    lane = clamp(lane + dir, 0, 2);
    if(lane !== prev){
      steer = dir < 0 ? "left" : "right";
      steerHold = 12;
    }
  }

  document.getElementById("leftBtn").addEventListener("pointerdown", () => move(-1));
  document.getElementById("rightBtn").addEventListener("pointerdown", () => move(1));

  window.addEventListener("pointerdown", (e) => {
    const x = e.clientX / window.innerWidth;
    if(x < 0.40) move(-1);
    else if(x > 0.60) move(1);
  }, { passive: true });

  // Loop met debug
  let last = 0;
  let fpsAcc = 0, fpsCount = 0, fps = 0;

  function loop(t){
    const dt = Math.min(0.033, ((t - last) / 1000) || 0);
    last = t;

    update(dt);
    render();

    fpsAcc += dt;
    fpsCount += 1;
    if(fpsAcc >= 0.5){
      fps = Math.round(fpsCount / fpsAcc);
      fpsAcc = 0;
      fpsCount = 0;
      elDbg.textContent = "debug: fps " + fps + ", cars " + carsReady + "/3";
    }

    requestAnimationFrame(loop);
  }

  requestAnimationFrame(loop);
})();
</script>
</body>
</html>