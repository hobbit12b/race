<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Letter Race 3D</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#0b0f14; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #ui {
      position: fixed; left: 12px; right: 12px; top: 10px;
      display: flex; gap: 10px; align-items: center; justify-content: space-between;
      pointer-events: none;
    }
    .pill {
      pointer-events: auto;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display:flex; align-items:center; gap:10px;
      user-select: none;
    }
    #targetLetter {
      font-size: 22px; font-weight: 800; letter-spacing: 0.5px;
      display:flex; align-items:center; gap:10px;
    }
    #bigLetter {
      width: 44px; height: 44px; border-radius: 12px;
      background: rgba(255,255,255,0.16);
      display:flex; align-items:center; justify-content:center;
      font-size: 26px; font-weight: 900;
    }
    #status {
      font-size: 18px; font-weight: 800;
    }
    #help {
      position: fixed; left: 12px; right: 12px; bottom: 12px;
      display:flex; justify-content: space-between; gap: 10px;
      pointer-events: none;
    }
    .btn {
      pointer-events: auto;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
      color:#fff;
      padding: 14px 16px;
      border-radius: 16px;
      font-weight: 800;
      min-width: 120px;
      text-align:center;
      user-select:none;
      touch-action: manipulation;
    }
    #overlay {
      position: fixed; inset: 0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(ellipse at center, rgba(20,30,45,0.92), rgba(5,7,10,0.96));
      color:#fff;
      z-index: 10;
    }
    #card {
      width: min(720px, calc(100% - 24px));
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      padding: 18px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #card h1 { margin: 0 0 8px 0; font-size: 22px; }
    #card p { margin: 6px 0; opacity: 0.92; line-height: 1.35; }
    #card .row { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    #card .row button {
      background: rgba(255,255,255,0.16);
      border: 1px solid rgba(255,255,255,0.16);
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 900;
      cursor: pointer;
    }
    canvas { display:block; }
  </style>
</head>
<body>

<div id="overlay">
  <div id="card">
    <h1>Letter Race 3D</h1>
    <p>Pak onderweg de juiste letter om turbo te krijgen.</p>
    <p>Bediening: tik links of rechts om van rijstrook te wisselen.</p>
    <p>Tip: begin met 3 letters, later voeg je er meer toe.</p>
    <div class="row">
      <button id="startBtn">Start</button>
      <button id="lettersEasyBtn">Letters: M, A, S</button>
      <button id="lettersAllBtn">Letters: A t m Z</button>
      <button id="soundBtn">Geluid: aan</button>
    </div>
  </div>
</div>

<div id="ui">
  <div class="pill" id="targetLetter">
    <div id="bigLetter">M</div>
    <div>Doelletter</div>
  </div>
  <div class="pill">
    <div id="status">ðŸ™‚</div>
    <div id="score">Score: 0</div>
  </div>
</div>

<div id="help">
  <div class="btn" id="leftBtn">Links</div>
  <div class="btn" id="rightBtn">Rechts</div>
</div>

<script type="module">
  import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";

  let scene, camera, renderer;
  let car, road, lights = [];
  let lane = 0;
  const lanes = [-2.2, 0, 2.2];
  let speed = 0.16;
  let baseSpeed = 0.16;
  let turboTime = 0;
  let slowTime = 0;

  let pickups = [];
  let activeLetters = ["M","A","S"];
  let target = "M";
  let score = 0;

  let running = false;
  let lastSpawnZ = -10;
  let rng = () => Math.random();

  const uiBig = document.getElementById("bigLetter");
  const uiStatus = document.getElementById("status");
  const uiScore = document.getElementById("score");
  const overlay = document.getElementById("overlay");

  let soundOn = true;

  function speak(text) {
    try {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "nl-NL";
      u.rate = 0.9;
      window.speechSynthesis.speak(u);
    } catch {}
  }

  function beep(ok = true) {
    if (!soundOn) return;
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = ok ? 720 : 190;
      g.gain.value = 0.08;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      setTimeout(() => { o.stop(); ctx.close(); }, ok ? 90 : 140);
    } catch {}
  }

  function setTarget(newTarget) {
    target = newTarget;
    uiBig.textContent = target;
    speak(`Pak de ${target}`);
  }

  function pickNewTarget() {
    const next = activeLetters[Math.floor(rng() * activeLetters.length)];
    setTarget(next);
  }

  function makeTextSprite(letter) {
    const canvas = document.createElement("canvas");
    canvas.width = 256;
    canvas.height = 256;
    const ctx = canvas.getContext("2d");

    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.fillRect(0,0,256,256);

    ctx.fillStyle = "rgba(255,255,255,0.22)";
    ctx.fillRect(18,18,220,220);

    ctx.font = "900 150px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "white";
    ctx.fillText(letter, 128, 132);

    const tex = new THREE.CanvasTexture(canvas);
    tex.anisotropy = 8;
    const mat = new THREE.SpriteMaterial({ map: tex, transparent: true });
    const sprite = new THREE.Sprite(mat);
    sprite.scale.set(1.1, 1.1, 1);
    return sprite;
  }

  function createPickup(letter, laneIndex, z) {
    const group = new THREE.Group();

    const baseGeom = new THREE.BoxGeometry(1.0, 0.6, 1.0);
    const baseMat = new THREE.MeshStandardMaterial({ color: 0x9aa6b2, roughness: 0.35, metalness: 0.25 });
    const base = new THREE.Mesh(baseGeom, baseMat);
    base.position.y = 0.35;
    group.add(base);

    const sprite = makeTextSprite(letter);
    sprite.position.set(0, 0.85, 0.52);
    group.add(sprite);

    group.position.set(lanes[laneIndex], 0, z);
    group.userData = { letter, laneIndex, hit: false };

    scene.add(group);
    pickups.push(group);
  }

  function spawnBatch() {
    const z = lastSpawnZ - 14 - rng() * 10;
    lastSpawnZ = z;

    const laneIndex = Math.floor(rng() * 3);
    const correctLane = laneIndex;

    const correctLetter = target;
    createPickup(correctLetter, correctLane, z);

    const otherLetters = activeLetters.filter(l => l !== correctLetter);
    for (let i = 0; i < 3; i++) {
      if (i === correctLane) continue;
      const l = otherLetters.length ? otherLetters[Math.floor(rng() * otherLetters.length)] : correctLetter;
      createPickup(l, i, z);
    }
  }

  function setupThree() {
    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x0b0f14, 8, 60);

    camera = new THREE.PerspectiveCamera(62, window.innerWidth / window.innerHeight, 0.1, 200);
    camera.position.set(0, 6.2, 9.5);
    camera.lookAt(0, 0.8, 0);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    document.body.appendChild(renderer.domElement);

    const hemi = new THREE.HemisphereLight(0xffffff, 0x1b2430, 1.0);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(6, 10, 6);
    scene.add(dir);

    const roadGeom = new THREE.PlaneGeometry(9, 200);
    const roadMat = new THREE.MeshStandardMaterial({ color: 0x111a24, roughness: 0.95, metalness: 0.0 });
    road = new THREE.Mesh(roadGeom, roadMat);
    road.rotation.x = -Math.PI / 2;
    road.position.z = -70;
    scene.add(road);

    const lineGeom = new THREE.BoxGeometry(0.12, 0.02, 4);
    const lineMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8, metalness: 0.0 });

    for (let i = 0; i < 20; i++) {
      const a = new THREE.Mesh(lineGeom, lineMat);
      a.position.set(-1.1, 0.02, -i * 10);
      scene.add(a);
      lights.push(a);

      const b = new THREE.Mesh(lineGeom, lineMat);
      b.position.set(1.1, 0.02, -i * 10);
      scene.add(b);
      lights.push(b);
    }

    const carGroup = new THREE.Group();
    const body = new THREE.Mesh(
      new THREE.BoxGeometry(1.1, 0.5, 2.0),
      new THREE.MeshStandardMaterial({ color: 0x2fd0ff, roughness: 0.35, metalness: 0.2 })
    );
    body.position.y = 0.45;
    carGroup.add(body);

    const top = new THREE.Mesh(
      new THREE.BoxGeometry(0.8, 0.35, 0.9),
      new THREE.MeshStandardMaterial({ color: 0x1e2a36, roughness: 0.6, metalness: 0.1 })
    );
    top.position.set(0, 0.75, -0.1);
    carGroup.add(top);

    const wheelMat = new THREE.MeshStandardMaterial({ color: 0x0b0f14, roughness: 0.95, metalness: 0.0 });
    const wheelGeom = new THREE.CylinderGeometry(0.18, 0.18, 0.18, 18);
    const offsets = [
      [-0.55, 0.22, 0.65],
      [ 0.55, 0.22, 0.65],
      [-0.55, 0.22,-0.65],
      [ 0.55, 0.22,-0.65]
    ];
    for (const [x,y,z] of offsets) {
      const w = new THREE.Mesh(wheelGeom, wheelMat);
      w.rotation.z = Math.PI / 2;
      w.position.set(x,y,z);
      carGroup.add(w);
    }

    car = carGroup;
    car.position.set(lanes[lane], 0, 2.2);
    scene.add(car);

    pickNewTarget();
    for (let i = 0; i < 4; i++) spawnBatch();

    window.addEventListener("resize", onResize);
  }

  function onResize() {
    if (!renderer || !camera) return;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function setStatus(emoji) {
    uiStatus.textContent = emoji;
  }

  function updateScore() {
    uiScore.textContent = `Score: ${score}`;
  }

  function moveLane(dir) {
    lane = Math.max(0, Math.min(2, lane + dir));
  }

  function checkCollisions() {
    for (const p of pickups) {
      if (p.userData.hit) continue;
      const dz = Math.abs(p.position.z - car.position.z);
      const dx = Math.abs(p.position.x - car.position.x);
      if (dz < 1.0 && dx < 0.9) {
        p.userData.hit = true;

        const ok = p.userData.letter === target;
        if (ok) {
          score += 1;
          turboTime = 70;
          slowTime = 0;
          setStatus("ðŸ˜„");
          beep(true);
          pickNewTarget();
        } else {
          slowTime = 60;
          turboTime = 0;
          setStatus("ðŸ˜¬");
          beep(false);
        }
        updateScore();

        scene.remove(p);
      }
    }
    pickups = pickups.filter(p => !p.userData.hit);
  }

  function tick() {
    if (!running) return;

    const laneX = lanes[lane];
    car.position.x += (laneX - car.position.x) * 0.18;

    if (turboTime > 0) {
      turboTime -= 1;
      speed = baseSpeed * 1.7;
    } else if (slowTime > 0) {
      slowTime -= 1;
      speed = baseSpeed * 0.75;
    } else {
      speed = baseSpeed;
      setStatus("ðŸ™‚");
    }

    for (const l of lights) {
      l.position.z += speed * 10;
      if (l.position.z > 8) l.position.z = -200;
    }

    for (const p of pickups) {
      p.position.z += speed * 10;
      if (p.position.z > 8) {
        scene.remove(p);
        p.userData.hit = true;
      }
    }
    pickups = pickups.filter(p => !p.userData.hit);

    while (pickups.length < 10) spawnBatch();

    checkCollisions();

    camera.position.x += (car.position.x - camera.position.x) * 0.08;
    camera.lookAt(car.position.x, 0.8, -8);

    renderer.render(scene, camera);
    requestAnimationFrame(tick);
  }

  function bindControls() {
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");

    const left = () => moveLane(-1);
    const right = () => moveLane(1);

    leftBtn.addEventListener("pointerdown", left);
    rightBtn.addEventListener("pointerdown", right);

    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") left();
      if (e.key === "ArrowRight") right();
    });

    window.addEventListener("pointerdown", (e) => {
      const x = e.clientX / window.innerWidth;
      if (x < 0.33) left();
      else if (x > 0.66) right();
    });
  }

  function startGame() {
    if (!scene) setupThree();
    running = true;
    overlay.style.display = "none";
    tick();
  }

  document.getElementById("startBtn").addEventListener("click", startGame);

  document.getElementById("lettersEasyBtn").addEventListener("click", () => {
    activeLetters = ["M","A","S"];
    setTarget(activeLetters[0]);
  });

  document.getElementById("lettersAllBtn").addEventListener("click", () => {
    activeLetters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    setTarget("A");
  });

  document.getElementById("soundBtn").addEventListener("click", (e) => {
    soundOn = !soundOn;
    e.target.textContent = soundOn ? "Geluid: aan" : "Geluid: uit";
  });

  bindControls();
</script>
</body>
</html>